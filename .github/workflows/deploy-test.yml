name: Deploy & Test FreeRADIUS

on:
  workflow_dispatch:
    inputs:
      architecture:
        description: "Target architecture"
        required: true
        default: "x86_64"
        type: choice
        options:
          - x86_64
      destroy_after_test:
        description: "Destroy infrastructure after tests complete"
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-2

jobs:
  # ────────────────────────────────────────────────
  # Job 1: Build RPM for selected architecture
  # ────────────────────────────────────────────────
  build:
    name: Build RPM (${{ inputs.architecture }})
    runs-on: ubuntu-latest
    container:
      image: amazonlinux:2023
    steps:
      - name: Install git
        run: dnf install -y git tar gzip

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build RPM
        run: ./rpm/build.sh --release "${{ github.sha }}"

      - name: Upload RPMs
        uses: actions/upload-artifact@v4
        with:
          name: freeradius-rpms-${{ inputs.architecture }}
          path: ~/rpmbuild/RPMS/**/*.rpm
          retention-days: 7

  # ────────────────────────────────────────────────
  # Job 2: Provision infra and deploy FreeRADIUS
  # ────────────────────────────────────────────────
  deploy:
    name: Deploy to AWS
    needs: build
    runs-on: ubuntu-latest
    outputs:
      instance_id: ${{ steps.tf-output.outputs.instance_id }}
      public_ip: ${{ steps.tf-output.outputs.public_ip }}
      rpm_bucket: ${{ steps.tf-output.outputs.rpm_bucket }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform init
        working-directory: terraform
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          terraform init \
            -backend-config="bucket=freeradius-lab-tfstate-${ACCOUNT_ID}" \
            -backend-config="dynamodb_table=freeradius-lab-tflock"

      - name: Terraform apply
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: Capture Terraform outputs
        id: tf-output
        working-directory: terraform
        run: |
          echo "instance_id=$(terraform output -raw freeradius_instance_id)" >> "$GITHUB_OUTPUT"
          echo "public_ip=$(terraform output -raw freeradius_public_ip)" >> "$GITHUB_OUTPUT"
          echo "rpm_bucket=$(terraform output -raw rpm_bucket_name)" >> "$GITHUB_OUTPUT"

      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          name: freeradius-rpms-${{ inputs.architecture }}
          path: ./rpms

      - name: Upload RPMs to S3
        run: |
          BUCKET=${{ steps.tf-output.outputs.rpm_bucket }}
          ARCH=${{ inputs.architecture }}
          aws s3 cp ./rpms/ "s3://${BUCKET}/rpms/${ARCH}/" \
            --recursive --exclude "*-debuginfo-*" --exclude "*-debugsource-*"
          echo "Uploaded RPMs:"
          aws s3 ls "s3://${BUCKET}/rpms/${ARCH}/"

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install Ansible
        run: uv tool install ansible-core --with boto3 --with botocore

      - name: Install session-manager-plugin
        run: |
          curl -sL -o /tmp/session-manager-plugin.deb \
            "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb"
          sudo dpkg -i /tmp/session-manager-plugin.deb

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r ansible/requirements.yml

      - name: Generate Ansible inventory
        run: |
          cat > ansible/inventory/inventory.aws_ssm.yml << EOF
          all:
            hosts:
              freeradius:
                ansible_host: ${{ steps.tf-output.outputs.instance_id }}
                ansible_connection: amazon.aws.aws_ssm
                ansible_aws_ssm_bucket_name: ${{ steps.tf-output.outputs.rpm_bucket }}
                ansible_aws_ssm_region: ${{ env.AWS_REGION }}
          EOF

      - name: Wait for SSM agent
        run: |
          INSTANCE_ID=${{ steps.tf-output.outputs.instance_id }}
          echo "Waiting for SSM agent on ${INSTANCE_ID}..."
          for i in $(seq 1 30); do
            STATUS=$(aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=${INSTANCE_ID}" \
              --query "InstanceInformationList[0].PingStatus" \
              --output text 2>/dev/null || echo "None")
            if [ "$STATUS" = "Online" ]; then
              echo "SSM agent is online after ~$((i * 10))s"
              break
            fi
            echo "  Attempt $i/30: status=$STATUS, waiting 10s..."
            sleep 10
          done
          if [ "$STATUS" != "Online" ]; then
            echo "ERROR: SSM agent did not come online within 5 minutes"
            exit 1
          fi

      - name: Deploy FreeRADIUS
        run: |
          ansible-playbook ansible/playbooks/deploy.yml \
            -i ansible/inventory/ \
            -e rpm_bucket=${{ steps.tf-output.outputs.rpm_bucket }} \
            -e rpm_arch=${{ inputs.architecture }}

  # ────────────────────────────────────────────────
  # Job 3: Smoke test
  # ────────────────────────────────────────────────
  smoke-test:
    name: Smoke Test
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install Ansible
        run: uv tool install ansible-core --with boto3 --with botocore

      - name: Install session-manager-plugin
        run: |
          curl -sL -o /tmp/session-manager-plugin.deb \
            "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb"
          sudo dpkg -i /tmp/session-manager-plugin.deb

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r ansible/requirements.yml

      - name: Generate Ansible inventory
        run: |
          cat > ansible/inventory/inventory.aws_ssm.yml << EOF
          all:
            hosts:
              freeradius:
                ansible_host: ${{ needs.deploy.outputs.instance_id }}
                ansible_connection: amazon.aws.aws_ssm
                ansible_aws_ssm_bucket_name: ${{ needs.deploy.outputs.rpm_bucket }}
                ansible_aws_ssm_region: ${{ env.AWS_REGION }}
          EOF

      - name: Run smoke tests
        run: |
          ansible-playbook ansible/playbooks/smoke_test.yml \
            -i ansible/inventory/

  # ────────────────────────────────────────────────
  # Job 4: Integration tests (pytest + pyrad over UDP)
  # ────────────────────────────────────────────────
  integration-test:
    name: Integration Tests
    needs: [deploy, smoke-test]
    runs-on: ubuntu-latest
    env:
      RADIUS_SERVER: ${{ needs.deploy.outputs.public_ip }}
      RADIUS_SECRET: testing123
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Run integration tests
        working-directory: tests
        run: uv run pytest -v

  # ────────────────────────────────────────────────
  # Job 5: Teardown (conditional)
  # ────────────────────────────────────────────────
  teardown:
    name: Teardown Infrastructure
    needs: [deploy, smoke-test, integration-test]
    if: always() && inputs.destroy_after_test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform destroy
        working-directory: terraform
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          terraform init \
            -backend-config="bucket=freeradius-lab-tfstate-${ACCOUNT_ID}" \
            -backend-config="dynamodb_table=freeradius-lab-tflock"
          terraform destroy -auto-approve
