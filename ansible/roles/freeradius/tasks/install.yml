---
- name: Create RPM download directory
  ansible.builtin.file:
    path: /tmp/rpms
    state: directory
    mode: "0755"

- name: Download RPMs from S3
  ansible.builtin.command:
    cmd: aws s3 cp "s3://{{ rpm_bucket }}/rpms/{{ rpm_arch }}/" /tmp/rpms/ --recursive
  changed_when: true

- name: Find downloaded RPMs
  ansible.builtin.find:
    paths: /tmp/rpms
    patterns: "{{ freeradius_rpm_packages }}"
    recurse: true
  register: freeradius_rpm_files

- name: Show discovered RPMs
  ansible.builtin.debug:
    msg: "{{ freeradius_rpm_files.files | map(attribute='path') | list }}"

- name: Fail if no RPMs found
  ansible.builtin.fail:
    msg: "No RPMs matched patterns {{ freeradius_rpm_packages }} under /tmp/rpms/"
  when: freeradius_rpm_files.matched == 0

- name: Install FreeRADIUS RPMs
  ansible.builtin.dnf:
    name: "{{ freeradius_rpm_files.files | map(attribute='path') | list }}"
    state: present
    disable_gpg_check: true

- name: Verify FreeRADIUS installation
  ansible.builtin.command: /usr/sbin/radiusd -v
  changed_when: false
  register: freeradius_radiusd_version

- name: Show FreeRADIUS version
  ansible.builtin.debug:
    var: freeradius_radiusd_version.stdout_lines
