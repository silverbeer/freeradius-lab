---
- name: Create RPM download directory
  ansible.builtin.file:
    path: /tmp/rpms
    state: directory
    mode: "0755"

- name: Clean previous RPM downloads
  ansible.builtin.shell: rm -f /tmp/rpms/*.rpm
  changed_when: true

- name: Download RPMs from S3
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      aws s3 cp "s3://{{ rpm_bucket }}/rpms/{{ rpm_arch }}/" /tmp/rpms/ \
        --recursive --exclude "*debuginfo*" --exclude "*debugsource*"
      cd /tmp/rpms
      find . -mindepth 2 -name '*.rpm' -exec mv {} . \;
      find . -type d -empty -delete
      for pkg in freeradius freeradius-config freeradius-utils freeradius-sqlite; do
        latest=$(ls -t ${pkg}-3*.rpm 2>/dev/null | head -1)
        if [ -n "$latest" ]; then
          ls ${pkg}-3*.rpm | grep -v "^${latest}$" | xargs -r rm -f
        fi
      done
      echo "RPMs to install:"
      ls -1 *.rpm
  changed_when: true

- name: Find downloaded RPMs
  ansible.builtin.find:
    paths: /tmp/rpms
    patterns: "{{ freeradius_rpm_packages }}"
  register: freeradius_rpm_files

- name: Verify RPMs were found
  ansible.builtin.assert:
    that:
      - freeradius_rpm_files.matched > 0
    fail_msg: "No RPMs found in /tmp/rpms matching {{ freeradius_rpm_packages }}"

- name: Install FreeRADIUS RPMs
  ansible.builtin.shell: |
    dnf install -y --nogpgcheck {{ freeradius_rpm_files.files | map(attribute='path') | join(' ') }}
  register: freeradius_dnf_result
  changed_when: "'Nothing to do' not in freeradius_dnf_result.stdout"

- name: Verify FreeRADIUS installation
  ansible.builtin.command: /usr/sbin/radiusd -v
  changed_when: false
  register: freeradius_radiusd_version

- name: Show FreeRADIUS version
  ansible.builtin.debug:
    var: freeradius_radiusd_version.stdout_lines
