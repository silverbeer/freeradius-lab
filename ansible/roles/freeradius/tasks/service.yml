---
- name: Enable and start radiusd
  ansible.builtin.systemd:
    name: radiusd
    state: started
    enabled: true

- name: Verify radiusd is running
  ansible.builtin.command: /usr/sbin/radiusd -C
  changed_when: false

- name: Verify RADIUS ports are listening
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      ss -ulnp | grep -q ':1812 ' && echo "auth ok" || exit 1
      ss -ulnp | grep -q ':1813 ' && echo "acct ok" || exit 1
  changed_when: false
  retries: 3
  delay: 5

- name: Verify Status-Server port is listening
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      ss -ulnp | grep -q ':{{ freeradius_status_server_port }} ' && echo "status ok" || exit 1
  changed_when: false
  retries: 3
  delay: 5
  when: freeradius_status_server_enabled

- name: Fix radius log file ownership for Vector
  ansible.builtin.file:
    path: /var/log/radius/radius.log
    owner: radiusd
    group: radiusd
    mode: "0640"
  when: vector_enabled | default(false) | bool
